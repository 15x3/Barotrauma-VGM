# Day1

- 初步上手
- 成功实现更为优雅简洁的配件机制

我需要开始考虑一下接下来怎么做战术插件.目前是考虑改造分为两类:战术化和暴力改造,前者就是原武器增加多个插件槽位,而后面的改造则是直接重写一个新武器出来.

对于插件槽位,目前的想法如下:

能影响的属性:
- reload & reloadnoskill 射速与无技能射速 (需要reloadskillrequirement)
- weapondamagemodifier 武器伤害倍率 
- penetration 护甲/结构伤害乘数 
- barrelpos 枪管位置 
- spread & unskilledspread 散布和无技能散布 
- crosshairscale 十字准星大小
- 移动速度

具体见 https://regalis11.github.io/BaroModDoc/ItemComponents/RangedWeapon.html

1. 上插件 | 镭射/灯光/发光管/瞄准镜等 | smallScopeVGM,bigScopeVGM
2. 枪管 | 消声器/消焰器/长枪管 | smallMuzzleVGM,bigMuzzleVGM
3. 下挂件 | 除瞄准镜以外的所有上挂件+握把 | smallAccessoryVGM,bigAccessoryVGM
4. 枪托 | 去除枪托/轻枪托/重枪托 | smallStockVGM,bigStockVGM
<!-- 5. 握把 | 人体工程学握把/轻握把/射手握把 | smallHandVGM,bigHandVGM -->
5. 内机构 | 灵活度较大 | smallMechanicsVGM,bigMechanicsVGM
6. 弹匣 | 不算在插件系统内,短弹匣/长弹匣/弹鼓 | smallMagVGM,bigMagVGM,drumMagVGM

就先做这些吧, 都是些数值增减, 应该不成问题的

明天得开始处理XML烧火棍生成器了,这下确实有实在的需求在了.

# Day2 

模板初步实现,做贴图时发现一个问题:配件和枪最好统一配色,不然装上去会显得突兀(尤其是握把部分),嗯,之后所有战术武器全变成暗蓝配色好了

生成器初步完工,不过还需要不少改进,目前生成的代码手动改的部分还挺多，另外最好能把贴图扔到右边，左边一栏右边一栏方便操作

发现枪握把有个问题:握把的实现略有难度:
1. 需要独立调整显示层级,得覆盖在枪握把的上面
2. 所有组件都最好比原枪配件大一码,以覆盖原枪

后来尝试了一下, subcontainer不响应containedspritedepth这个标签,故因握把贴图实现难度过大的原因,实现得弃用

# Day3

枪械配件列表：

上插件：
    步枪瞄准镜（原版） 增加武器的最远可视距离（cameraaimoffset）500单位，只有部分武器可用
    ACOG瞄准镜 增加武器的最远可视（cameraaimoffset）距离250单位
    全息瞄准镜 增加武器的最远可视100单位
        - 变种：红点瞄准镜
        - 变种：紧凑瞄准镜
    狙击瞄准镜 增加武器最远可视距离700单位，只有部分武器可用，影响持握时步行速度

上下兼容插件：
    激光瞄准器 
    手电筒
    照明棒
    信号弹
        -以上物品安装在上插件时会导致准星消失

下插件：
    垂直握把 变为战术持握（枪口向下）
    直角握把 变为战术持握（枪口向上）

枪管：
    消声器 修改武器枪管位置，减少5%散布，增加消音能力，增加5%伤害
    消焰器 减少15%散布
    长枪管 修改武器枪管位置，增加10%伤害，减少10%移动速度，增大枪口火焰

枪托：
    无枪托(默认) 增加30%散布,增加15%移动速度
    轻型枪托 有托武器的默认配置
    重型枪托 减少5%移动速度，减少5%散布
    射手枪托 减少15%移动速度，减少30%散布
    （手枪枪托 减少20%散布，但是变为只能双手持握）


第一批贴图完成,只做了一半,主要是确认一下当前这套工作流可行,晚上准备开工处理代码
我把以前不知道在哪里找到的旧式工作台搬来了,现在当作这个mod的用好了

哈,幸好只做了一半,果然有坑:
xml原生支持增减这些操作,但是不支持TMD逆向操作!啥意思?老子消音器捅上去之后再拔下来,桶上去会给数值,拔下来数值没法变回去!笑死,好吧是可以变回去,用setvalue就行,但是如果一个属性被两种不同的插件影响(比如常见的,散布同时被握把和枪托影响),那逻辑上就会出现问题.

我想了想,这样的话得减一些特性:一个插件可以影响,每个属性只能固定被一种插件定义,

至于剩下的,我想之后学lua的时候试试好了...如果我还有余力去学lua而不是专注Godot的话

我就把话放在这儿了:如果不使用Lua重写的话,这个东西的拓展会很困难.所以等第一版出来以后,尽早用Lua把逻辑重写一遍

原版突击步枪的弹匣怎么贴图位置不对? 这个做完了帮官方修一下

<Item identifier="tacAssaultRifleVGM" name="tacAssaultRifleVGM" tags="smallitem,weapon" category="Weapon" scale="0.5" impactsoundtag="impact_metal_light">
<!-- interactdistance="50" interactpriority="1.0" interactthroughwalls="false" focusonselected="false" offsetonselected="0" showcontentsintooltip="false" scale="1.0" spritecolor="1.0,1.0,1.0,1.0" health="100" indestructible="false" fireproof="false" waterproof="false" impacttolerance="10.0" maxstacksize="1" allowasextracargo="false" allowrotatingineditor="true" linkable="false"这些都不需要 -->
  <Price baseprice="666">
    <Price storeidentifier="merchantoutpost" sold="false" multiplier="1.5" />
    <Price storeidentifier="merchantcity" multiplier="1.25" minavailable="1" sold="false" />
    <Price storeidentifier="merchantresearch" sold="false" multiplier="1.25" />
    <Price storeidentifier="merchantmilitary" multiplier="0.9" minavailable="1" />
    <Price storeidentifier="merchantmine" sold="false" multiplier="1.25" />
    <Price storeidentifier="merchantarmory" multiplier="0.9" minavailable="1" />
    <!-- price需要增加storeidentifier作为子标签 -->
  </Price>
  <Fabricate requiredtime="35" suitablefabricators="fabricatorVGM">
    <RequiredItem identifier="assaultrifle" amount="1" mincondition="0" />
    <RequiredItem identifier="steel" amount="3" mincondition="0" />
  </Fabricate>
  <Deconstruct time="10">
    <Item identifier="plastic" />
    <Item identifier="titaniumaluminiumalloy" />
  </Deconstruct>
  <Body width="160" height="60" density="25" />
  <RangedWeapon reload="0.24" weapondamagemodifier="1.0" penetration="" holdtrigger="true" barrelpos="75,-20" spread="6" unskilledspread="20" combatpriority="80" drawhudwhenequipped="true">
    <Crosshair texture="Content/Items/Weapons/Crosshairs.png" sourcerect="0,256,256,256" scale="0.2" />
    <CrosshairPointer texture="Content/Items/Weapons/Crosshairs.png" sourcerect="256,256,256,256" />
    <RequiredItems items="smgammo" type="Contained" msg="ItemMsgAmmoRequired" />
    <RequiredSkill identifier="weapons" level="60" />
    <!-- <StatusEffect type="OnUse" target="This" Condition="-0.01" /> -->
    <!-- <StatusEffect type="OnUse" target="Contained" Condition="-0.1" /> -->
    <!-- <StatusEffect type="OnUse" target="Character" DisableDetachment="true">
        <Explosion force="0" smoke="true" flames="false" shockwave="false" sparks="false" flash="false" sound="SmallWeaponShoot" />
    </StatusEffect> -->
    <!-- 上面这三行都不需要,请修改成下面这些 -->
    <StatusEffect type="OnUse" target="This">
      <ParticleEmitter particle="casingfirearm" particleamount="1" anglemin="90" anglemax="150" velocitymin="50" velocitymax="250" CopyEntityAngle="true" />
      <Explosion range="150.0" force="1.5" shockwave="false" smoke="false" flames="false" sparks="false" underwaterbubble="false" camerashake="12.0" />
    </StatusEffect>
    <StatusEffect type="OnUse" target="Contained">
      <Use />
    </StatusEffect>
    <StatusEffect type="OnSecondaryUse" target="This" Condition="-0.1" stackable="true" disabledeltatime="true" setvalue="false" >
      <RequiredItem items="flashlight" type="Contained" />
    </StatusEffect>
  </RangedWeapon>
  <ItemContainer capacity="1" maxstacksize="1" hideitems="false" containedstateindicatorslot="0" containedstateindicatorstyle="bullet" containedspritedepth="0.56">
    <!-- <SlotIcons>
      <SlotIcon slot="0" texture="Content/Items/InventoryIconAtlas.png" sourcerect="832,830,64,64" />
      <SlotIcon slot="1" texture="Content/UI/StatusMonitorUI.png" sourcerect="320,448,64,64" />
      <SlotIcon slot="3" texture="%ModDir%/UI/icons.png" sourcerect="0,64,64,64" />
      <SlotIcon slot="4" texture="%ModDir%/UI/icons.png" sourcerect="64,0,64,64" />
      <SlotIcon slot="5" texture="%ModDir%/UI/icons.png" sourcerect="128,0,64,64" />
    </SlotIcons> -->
    <!-- sloticons和index是错误的写法,正确写法请参考如下: -->
      <SlotIcon slotindex="0" texture="Content/UI/StatusMonitorUI.png" sourcerect="256,448,64,64" origin="0.5,0.5" />
      <SlotIcon slotindex="1" texture="Content/UI/StatusMonitorUI.png" sourcerect="320,448,64,64" origin="0.5,0.5" />
      <SlotIcon slotindex="2" texture="%ModDir%/UI/icons.png" sourcerect="192,0,64,64" origin="0.5,0.5" />
      <SlotIcon slotindex="3" texture="%ModDir%/UI/icons.png" sourcerect="256,0,64,64" origin="0.5,0.5" />
      <SlotIcon slotindex="4" texture="%ModDir%/UI/icons.png" sourcerect="64,0,64,64" origin="0.5,0.5" />
      <SlotIcon slotindex="5" texture="%ModDir%/UI/icons.png" sourcerect="128,0,64,64" origin="0.5,0.5" />
    <!-- <Contained items="smgammo,smallMagVGM,bigMagVGM,drumMagVGM" hide="false" itempos="-19,1" rotation="-30" /> -->
    <!-- 请把Contained换成Containable -->
    <!-- <SubContainer capacity="1" maxstacksize="1" allowitems="smallAccessoryVGM,bigAccessoryVGM,light" hideitems="false" itempos="22,-2" setactive="true" type="LowerAccessory">
      <StatusEffect type="OnContained" target="This" CheckConditionalAlways="true">
        <Conditional Is=!"tacAssaultRifleVGM" />
        <Remove />
      </StatusEffect>
    </SubContainer> -->
    subcontainer的写法存在错误,这里我给你留着第一行,你按照我的写法来做,所有的StatusEffect不需要生成,需要containable即可
      <SubContainer capacity="1" maxstacksize="1">
        <Containable items="smallAccessoryVGM,bigAccessoryVGM,light" hide="false" itempos="22,-1" setactive="true" >
        </Containable>
      </SubContainer>
      <SubContainer capacity="1" maxstacksize="1">
        <Containable items="smallHandVGM,bigHandVGM" hide="false" itempos="22,-1" setactive="true" >
        </Containable>
      </SubContainer>
      <SubContainer capacity="1" maxstacksize="1">
        <Containable items="smallMuzzleVGM,bigMuzzleVGM" hide="false" itempos="22,-1" setactive="true" >
        </Containable>
      </SubContainer>
      <!-- 枪托 -->
      <SubContainer capacity="1" maxstacksize="1">
        <Containable items="smallStockVGM,bigStockVGM" hide="false" itempos="22,-1" setactive="true" >
        </Containable>
      </SubContainer>
      <!-- 上挂件 -->
      <SubContainer capacity="1" maxstacksize="1">
        <Containable items="smallScopeVGM,bigScopeVGM" hide="false" itempos="22,-1" setactive="true" >
        </Containable>
      </SubContainer>
  </ItemContainer>
  <Sprite texture="Content/Items/Weapons/weapons_new.png" sourcerect="94,8,161,59" depth="0.55" origin="0.5,0.5" scale="0.5" />
  <InventoryIcon texture="Content/Items/InventoryIconAtlas.png" sourcerect="94,8,161,59" origin="0.5,0.5" />
  <Holdable slots="Any,RightHand+LeftHand" controlpose="true" holdpos="40,-10" aimpos="45,-10" handle1="-30,-15" handle2="26,5" holdangle="-35" msg="ItemMsgPickUpSelect" />
</Item>


# Day4
好吧,Alpha阶段算是ok了,调试了2把武器和8个配件,接下来可以进入大批量生产阶段了,哦对了,我最好确认一下合成配方,Day6做差不多的时候再添加好了


# Day5
大规模生产的一天,今明两天可以把所有武器做完,不过我好像忘了做延长弹匣和弹鼓,今天还是先完成这个,并且进一步优化我的生成器好了